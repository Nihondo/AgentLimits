# AgentLimits

**開発中**

macOS Sonoma以降向けのメニューバーアプリと通知センターウィジェットで、ChatGPT Codex / Claude Code の使用量（5時間・週）と ccusage のトークン使用量を表示します。

![](./images/agentlimit_sample.png)

## 最新版ダウンロード
最新版はこちらからダウンロードしてください: [ダウンロード](https://github.com/Nihondo/AgentLimits/releases/latest/download/AgentLimits.zip)

## 機能概要

### メニューバーステータス表示
- メニューバーに使用率をリアルタイム表示
- 有効なプロバイダ（Codex/Claude）ごとに5時間/週の使用率を2行で表示
  - 1行目: サービス名
  - 2行目: `X% / Y%`（5時間 / 週）
- 色分け表示:
  - 使用量表示: 緑（70%未満）、オレンジ（70〜89%）、赤（90%以上）
  - 残り表示: 緑（31%以上）、オレンジ（11〜30%）、赤（10%以下）
- プロバイダごとに表示のオン/オフを設定可能（使用量設定タブのサービス選択のすぐ下）
- 表示モード（使用/残り）の変更に対応
- `ImageRenderer` でメニューバー表示を描画

### 使用量モニタリング（Codex / Claude）
- アプリ内WKWebViewで対象サービスにログイン（Codex/Claudeを切替）
- 使用量は内部APIから自動取得:
  - Codex: `https://chatgpt.com/backend-api/wham/usage`（JSON）
  - Claude: `https://claude.ai/api/organizations/{orgId}/usage`（JSON）
- App Group `group.com.dmng.agentlimit` にプロバイダ別スナップショット保存
- Codex用 / Claude用の別ウィジェットとして表示
- 自動更新: 1〜10分で設定可能（使用量設定画面のサービス選択の右側メニュー）
- 表示モード（使用/残り）はメニューバーから切り替え
- ウィジェットのパーセンテージ表示は表示モードと使用率に応じて色分け

### ccusage トークン使用量
- CLIで取得し、スナップショットを保存
  - Codex: `npx -y @ccusage/codex@latest daily`
  - Claude: `npx -y ccusage@latest daily`
- 今日/今週/今月のトークン数とコストを表示
- Codex用 / Claude用の別ウィジェットとして表示
- **小サイズウィジェット**: 使用量サマリー（今日/今週/今月）
- **中サイズウィジェット**: 使用量サマリー + GitHub風ヒートマップ（当月の日別使用量を表示）
  - 7行（日〜土）× 4〜6列（週）
  - 四分位数に基づく5段階の色濃度
  - 曜日ラベル（Mon, Wed, Fri）を表示
  - デスクトップ固定モード対応（グレースケール/アクセント描画）
- 自動更新: 1〜10分で設定可能（ccusage設定画面のサービス選択の右側メニュー）
- ウィジェットタップで `https://ccusage.com/` を開く

### Wake Up（CLIスケジューラ）
- 指定した時刻にCLIコマンド（`codex exec --skip-git-repo-check "hello"` / `claude -p "hello"`）を自動実行
- LaunchAgentで実装（macOS標準の定期実行機能）
- プロバイダ別にスケジュール設定可能
- 追加の引数（例: `--model="haiku"`）を設定可能
- LaunchAgentのplist: `~/Library/LaunchAgents/com.dmng.agentlimit.wakeup-*.plist`
- ログ: `/tmp/agentlimit-wakeup-*.log`
- **何のための機能？** 9時からセッションを開始して、12時には使い切ってしまい14時まで何もできなくなるケースがよくあります。その場合、7時にセッションを開始しておけば、12時にはセッションがリセットされて再び利用できるようになります。

### 閾値通知
- 使用量が閾値を超えると通知センターに警告を表示
- プロバイダ別（Codex / Claude）に設定可能
- ウィンドウ別（5時間 / 週）に設定可能
- デフォルト閾値: 90%
- 同じリセットサイクル内では1回のみ通知（重複防止）

## 基本の使い方
1. AgentLimitsアプリを実行
2. 通知センターでウィジェットを追加
3. メニューバーのアイコンから「AgentLimits設定...」を選ぶ
4. 画面上部でCodex/Claudeを切り替える
5. 画面右側の更新間隔メニューで 1〜10分 を選択
6. 画面下部のWebViewで対象サービスにログイン
7. メニューバーの「表示モード」から使用量/残り使用量を切り替える
8. 「今すぐ更新」は選択中のサービスのみ更新します

### メニューバーステータス設定
1. 使用量設定タブを開く
2. 各プロバイダ（Codex/Claude）の「メニューバーに表示」をオン/オフ
3. 有効なプロバイダの使用率がメニューバーにリアルタイム表示されます

### ccusage 設定
1. メニューバーから「ccusage 設定...」を選択
2. プロバイダを選択（Codex / Claude）
3. 画面右側の更新間隔メニューで 1〜10分 を選択
4. 「定期取得を有効にする」をオン
5. 「今すぐテスト実行」でCLI動作を確認

### Wake Up 設定
1. メニューバーから「Wake up設定...」を選択
2. プロバイダを選択（Codex / Claude Code）
3. 「スケジュールを有効にする」をオン
4. 実行したい時刻（0〜23時）を選択
5. 「今すぐテスト実行」でCLI動作を確認

### 閾値通知設定
1. メニューバーから「閾値通知設定...」を選択
2. 通知権限をリクエスト（初回のみ）
3. プロバイダを選択（Codex / Claude Code）
4. 5時間/週間のそれぞれで閾値を設定

## 表示内容
- 使用量ウィジェット:
  - 5時間の使用率（%）または残り（%）
  - 週あたりの使用率（%）または残り（%）
  - 最終更新（相対表示）
  - 使用率に応じた色分け表示
- ccusageウィジェット:
  - 今日/今週/今月のコスト（USD）
  - 今日/今週/今月のトークン数
  - 最終更新（相対表示）
- メニューバー:
  - プロバイダ名（Codex/Claude）を1行目に表示
  - `X% / Y%` を2行目に表示（色分け）

## 注意
- 取得は内部APIに依存します。仕様変更で取得できなくなる可能性があります。
- ccusageのCLI出力仕様が変わると取得できなくなる可能性があります。
- Widgetの更新頻度はOSにより間引かれる場合があります。
- 閾値通知には通知権限が必要です。
- CLIの起動はzsh経由で行っており、zsh環境でcodex, claude, npx コマンドへのPATHが通っている必要があります
- Claudeのログインに失敗し、複数回のログイン作業が必要になる可能性があります
