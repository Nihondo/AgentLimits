# AgentLimits

**開発中**

macOS Sonoma以降向けのメニューバーアプリと通知センターウィジェットで、ChatGPT Codex / Claude Code の使用量（5時間・週）と ccusage のトークン使用量を表示します。

![](./images/agentlimit_sample.png)

## 最新版ダウンロード
最新版はこちらからダウンロードしてください: [ダウンロード](https://github.com/Nihondo/AgentLimits/releases/latest/download/AgentLimits.zip)

## 機能概要

### メニューバーステータス表示
- メニューバーに使用率をリアルタイム表示
- 有効なプロバイダ（Codex/Claude）ごとに5時間/週の使用率を2行で表示
  - 1行目: サービス名
  - 2行目: `X% / Y%`（5時間 / 週）
- 色分け表示:
  - 使用率表示: 正常域 / 警告域 / 危険域
  - 残り表示: 正常域 / 警告域 / 危険域（閾値は使用率表示と逆）
- プロバイダごとに表示のオン/オフを設定可能（使用量設定タブ）
- 表示モード（使用/残り）の変更に対応
- `ImageRenderer` でメニューバー表示を描画
- 使用率の色（正常/警告/危険）は詳細設定でカスタマイズ可能

### 使用量モニタリング（Codex / Claude）
- アプリ内WKWebViewで対象サービスにログイン（Codex/Claudeを切替）
- 使用量は内部APIから自動取得:
  - Codex: `https://chatgpt.com/backend-api/wham/usage`
  - Claude: `https://claude.ai/api/organizations/{orgId}/usage`
- App Group `group.com.dmng.agentlimit` にプロバイダ別スナップショット保存
- Codex用 / Claude用の別ウィジェットとして表示
- 自動更新: 1〜10分で設定可能
- 表示モード（使用/残り）はメニューバーから切り替え
- ウィジェットのパーセンテージ表示は表示モードと使用率に応じて色分け

### ccusage トークン使用量
- CLIで取得し、スナップショットを保存
  - Codex: `npx -y @ccusage/codex@latest daily`
  - Claude: `npx -y ccusage@latest daily`
- 今日/今週/今月のトークン数とコストを表示
- Codex用 / Claude用の別ウィジェットとして表示
- **小サイズウィジェット**: 使用量サマリー（今日/今週/今月）
- **中サイズウィジェット**: 使用量サマリー + GitHub風ヒートマップ（当月の日別使用量を表示）
  - 7行（日〜土）× 4〜6列（週）
  - 四分位数に基づく5段階の色濃度
  - 曜日ラベル（Mon, Wed, Fri）を表示
  - デスクトップ固定モード対応（グレースケール/アクセント描画）
- 自動更新: 1〜10分で設定可能
- ウィジェットタップで `https://ccusage.com/` を開く

### Wake Up（CLIスケジューラ）
- 指定した時刻にCLIコマンド（`codex exec --skip-git-repo-check "hello"` / `claude -p "hello"`）を自動実行
- LaunchAgentで実装（macOS標準の定期実行機能）
- プロバイダ別にスケジュール設定可能
- 追加の引数（例: `--model="haiku"`）を設定可能
- LaunchAgentのplist: `~/Library/LaunchAgents/com.dmng.agentlimit.wakeup-*.plist`
- ログ: `/tmp/agentlimit-wakeup-*.log`

### 閾値通知
- 使用率が閾値を超えると通知センターに警告を表示
- プロバイダ別（Codex / Claude）に設定可能
- ウィンドウ別（5時間 / 週）に設定可能
- デフォルト閾値: 90%
- 同じリセットサイクル内では1回のみ通知（重複防止）

### 詳細設定（CLIパス / 色）
- codex / claude / npx の**フルパス**を個別に指定可能（空欄なら PATH から解決）
- PATH解決結果を画面に表示
- ドーナツグラフの色を設定可能
- 使用率の色（正常域/警告域/危険域）を設定可能（メニューバー + ウィジェット）
- 「使用率に従って色を変える」をオンにすると、ドーナツは使用率色で描画
- 「デフォルトに戻す」で色設定を初期値に戻す

## 基本の使い方
1. AgentLimitsアプリを実行
2. 通知センターでウィジェットを追加
3. メニューバーのアイコンから「AgentLimits設定...」を選ぶ
4. 画面上部でCodex/Claudeを切り替える
5. 更新間隔を 1〜10分 から選択
6. WebViewで対象サービスにログイン
7. メニューバーの「表示モード」から使用率/残り使用率を切り替える
8. 「今すぐ更新」は選択中のサービスのみ更新

## 設定画面の使い方

### 使用量設定
1. **使用量**タブを開く
2. Codex / Claude を選択
3. 更新間隔（1〜10分）を選択
4. 「メニューバーに表示」をプロバイダごとに切替
5. WebViewでログイン

### メニューバーステータス
1. 表示したいプロバイダで「メニューバーに表示」をオン
2. `X% / Y%`（5時間 / 週）がメニューバーに表示される

### ccusage 設定
1. **ccusage**タブを開く
2. プロバイダ（Codex / Claude）を選択
3. 更新間隔（1〜10分）を選択
4. 「定期取得を有効にする」をオン
5. 「今すぐテスト実行」でCLI動作を確認

### Wake Up 設定
1. **Wake Up**タブを開く
2. プロバイダ（Codex / Claude Code）を選択
3. スケジュールを有効化
4. 実行したい時刻（0〜23時）を選択
5. 「今すぐテスト実行」でCLI動作を確認

### 閾値通知設定
1. **通知**タブを開く
2. 通知権限をリクエスト（初回のみ）
3. プロバイダ（Codex / Claude Code）を選択
4. 5時間 / 週の閾値を設定

### 詳細設定
1. **詳細設定**タブを開く
2. `codex` / `claude` / `npx` のフルパスを必要に応じて指定
3. PATH解決結果を確認
4. ドーナツ色・使用率色をカスタマイズ
5. 「使用率に従って色を変える」を必要に応じてオン
6. 「デフォルトに戻す」で色設定を初期値に戻す

## 注意
- 取得は内部APIに依存します。仕様変更で取得できなくなる可能性があります。
- ccusageのCLI出力仕様が変わると取得できなくなる可能性があります。
- ウィジェットの更新頻度はOSにより間引かれる場合があります。
- 閾値通知には通知権限が必要です。
- CLIの実行は**ユーザーのログインシェル**で行います。
- 実行前に PATH を `"/opt/homebrew/bin:/usr/local/bin:$HOME/.local/bin:$PATH"` で拡張します。
- 詳細設定でフルパスを指定した場合は、そのパスを優先して実行します。
- Claudeのログインに失敗し、複数回のログイン作業が必要になる可能性があります。
